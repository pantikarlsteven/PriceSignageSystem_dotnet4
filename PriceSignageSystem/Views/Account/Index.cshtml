
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
    @*<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">*@
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="~/Scripts/jquery-3.6.0.min.js"></script>
    @*<script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>*@
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>


</head>
<body>
    <div class="content-wrapper bg-white px-3">
        <div class="row">
            <div class="card elevation-3  px-0 ">
                <ul class="nav nav-tabs bg-primary1 px-2 pt-2">
                    <li class="nav-item">
                        <a class="nav-link nav-link-tab active" style="color:white;" data-toggle="tab" href="#register">Register</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-tab" style="color:white;" data-toggle="tab" href="#userInfo">User Info</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="register" class="tab-pane active mx-2">
                        <h3 class="text-center mt-2">Account Registration</h3>

                        @using (Html.BeginForm("Register", "Account", FormMethod.Post, new { id = "registerForm" }))
                        {
                            <div class="form-group">
                                <label for="empid">Employee ID</label>
                                <input type="text" class="form-control" id="empid" name="empid" />
                            </div>
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" class="form-control" id="username" name="username" />
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" name="password" />
                            </div>
                            <div class="form-group">
                                <label for="roleList">Role</label>
                                <select class="form-control custom-select" id="roleList" name="roleList">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        }
                    </div>

                    <div id="userInfo" class="tab-pane fade mx-2">
                        <h3 class="text-center mt-2">User Account Information</h3>

                        <table id="userList" class="table table-sm table-hover" style="width: 100%; text-align: center;">
                            <thead style="background-color: #1C3766;" class="text-white">
                                <tr>
                                    <th>Employee ID</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" style="text-align: center;">This data is hidden</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                </div>
                <div class="modal-body">
                    <div class="modal-message">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Ok</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal" id="updateUserModal" tabindex="-1" aria-labelledby="updateUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateUserModalLabel">Confirm Update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to update this user?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelUpdateBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmUpdateBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this user?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
<script>
    var registerModal = document.getElementById('registerModal');
    var userDT = null;
    var roles = [];

    $(document).ready(function () {

        // FIX 
        $('.nav-link-tab').click(function () {
            // Remove 'active' class from all tabs
            $('.nav-link-tab').removeClass('active');

            // Add 'active' class to the clicked tab
            $(this).addClass('active');

            // Get the href value of the clicked tab
            var tabId = $(this).attr('href');

            // Show the corresponding tab content
            $('.tab-pane').removeClass('show active');
            $(tabId).addClass('show active');

            var currentActiveTab = $('.nav-link-tab.active').attr('href');
            if (currentActiveTab == "#userInfo") {
                userDT.draw();
            }
        });

        // FIX TABLE WHEN SIDE NAV IS COLLAPSED
        $('.nav-link-burger').click(function () {
            setTimeout(function () {
                $("a.nav-link-tab.active").trigger("click");
            }, 300);
        });

        // REGISTER FORM SUBMIT EVENT
        $('#registerForm').submit(function (event) {
            event.preventDefault();

            var formData = $(this).serialize();

            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: formData,
                success: function (response) {

                    document.querySelector("#registerModal .modal-title").textContent = response.message;
                    document.querySelector("#registerModal .modal-message").textContent = response.exceptionDetails;
                    registerModal.style.display = 'block';
                },
                error: function (error) {

                }
            });

        });

        $.ajax({
            url: '/Account/GetUserInformation',
            type: 'POST',
            success: function (response) {

                if (userDT !== null) {
                    userDT.destroy();
                }
                LoadUserDatatable(response);
            },
            error: function (err) {}
        })

        // List Of Users Datatable
        function LoadUserDatatable(data) {
            userDT = $('#userList').DataTable({
                scrollY: 500,
                scrollX: true,
                scroller: true,
                deferRender: true,
                data: data,
                lengthMenu: [
                    [10, 25, 50, -1],
                    [10, 25, 50, 'All']
                ],
                pageLength: -1,
                columnDefs: [
                    { targets: [3], orderable: false },
                ],
                columns: [
                    {
                        data: null, orderable: false, searchable: false, render: function (data) {
                            return '<input type="text" class="form-control" id="empId-'+ data.UserId +'" value="'+data.EmployeeId +'">';
                        }
                    },
                    { data: 'UserName', name: 'UserName' },
                    {
                        data: null, orderable: false, searchable: false, render: function (data) {
                            return '<select class="form-control custom-select role-select" id="role-select-' + data.UserId +'-'+ data.RoleId+ '">' +
                                    '<option value=""> Loading...</option>'+
                                    '</select>';
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-warning btn-sm" onclick=\'updateUser(' + JSON.stringify(row) + ')\'>Update</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + data.UserId + ')">Delete</button>';
                        }
                    }
                ],
                "dom": '<"top"lfB>rt<"bottom"ip>',
                // After table initialization
                "initComplete": function () {
                    populateRoleSelects();
                }
            });
        }
    });

    // GET USER ROLES FOR REGISTRATION
    fetch('/Account/GetRoles')
        .then(response => response.json())
        .then(data => {
            
            const selectElement = document.getElementById('roleList');
            selectElement.innerHTML = '';
            data.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.Value;
                optionElement.textContent = option.Text;
                selectElement.appendChild(optionElement);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

    fetch('/Account/GetRoleList')
        .then(response => response.json())
        .then(data => {
            roles = data;
        });
       
    function populateRoleSelects() {
       
        $('.role-select').each(function () {
            const selectElement = $(this);
            const userId = selectElement.attr('id').split('-')[2];
            const roleId = selectElement.attr('id').split('-')[3];

            selectElement.empty();

            roles.forEach(role => {
                selectElement.append('<option value="' + role.Id + '">' + role.Name + '</option>');
            });

            // selected Val
            selectElement.val(roleId);
        });
    }

    function closeModal() {
        registerModal.style.display = 'none';
        document.querySelector("#registerModal .modal-title").textContent = "";
        document.querySelector("#registerModal .modal-message").textContent = "";
        window.location.href = '/Account/Index';
    }

    function deleteUser(id) {
        const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        modal.show();

        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            modal.hide();

            $.ajax({
                url: "/Account/DeleteUserById",
                type: "POST",
                data: { id: id },
                success: function (response) {
                    if (response) {
                        window.location.reload();
                        alert('User Deleted Succesfully!')
                    } else {
                        alert('Action Denied!')
                    }
                },
                error: function () {}
            })
        });
        
        document.getElementById('cancelDeleteBtn').addEventListener('click', function () {
            modal.hide();
        });
    }

    function updateUser(data) {
        var empId = $(`#empId-${data.UserId}`).val();
        var roleId = $(`#role-select-${data.UserId}-${data.RoleId}`).val();
        var dto = {
            UserId: data.UserId,
            EmployeeId: empId,
            RoleId: roleId
        };

        if (empId == '') {
            alert('Employee ID is required!');
            return false;
        }

        const modal = new bootstrap.Modal(document.getElementById('updateUserModal'));
        modal.show();

        document.getElementById('confirmUpdateBtn').addEventListener('click', function () {
            modal.hide();

            $.ajax({
                url: "/Account/UpdateUserInfo",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ dto: dto  }),
                success: function (response) {
                    if (response) {
                        window.location.reload();
                        alert('User Updated Succesfully!')
                    } else {
                        alert('Action Denied!')
                    }
                },
                error: function () { }
            })
        });

        document.getElementById('cancelUpdateBtn').addEventListener('click', function () {
            modal.hide();
        });
        
    }
</script>

